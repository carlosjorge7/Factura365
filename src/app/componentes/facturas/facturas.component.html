<div id="facturas" *ngIf="log">
  <div *ngIf="!upd && !updLin">
    <div class="container">
      <div>
        <br>
        <h3 style="margin-bottom: -30px;"><i class="fas fa-file-invoice"></i> Facturas</h3>

      </div>

      <div class="form-inline my-2 my-lg-0" style="float:right;">
        <input style="border-radius: 20px; margin-left: 30px;" id="buscar" name="filterFacturas"
          class="form-control mr-sm-2" type="search" placeholder="Buscar" aria-label="Search" [(ngModel)]="filterFacturas">
      </div>

      <div style="float: right;" class="row">
        <button style="margin-right: 25px;" class="btn btn-outline-success" (click)="exportAsXLSX()"><i
            class="fas fa-file-excel"></i> Exportar</button>
        <div style="margin-left: -20px;">
          <button (click)="generateRandom()" class="btn btn-outline-primary"><i class="fas fa-plus-circle"></i> Nueva</button>
        </div>
      </div>

    </div>
    <br><br><br>
    <div class="table table-responsive">
      <table id="table" class="table table-hover" *ngIf="hayRegistros(); else sinfacturas">
        <thead>
          <tr>
            <td><strong>Fecha</strong></td>
            <td><strong>Tipo</strong></td>
            <td><strong>Nº</strong></td>
            <td><strong>P.o.</strong></td>
            <td><strong>Cliente</strong></td>
            <td><strong>Estado</strong></td>
            <td><strong>Vencimiento</strong></td>
            <td><strong>Importe</strong></td>
            <td><strong>Adeudado</strong></td>
            <td><strong>Editar</strong></td>
            <td><strong>Borrar</strong></td>
            <td><strong>Opciones</strong></td>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let fac of facturas | filterFac: filterFacturas | paginate: { itemsPerPage: 15, currentPage: page }">
            <td>{{fac.InvoiceDate}}</td>
            <td>{{fac.TypeName}}</td>
            <td>{{fac.InvoiceNumber}}</td>
            <td>{{fac.PurchaseOrder}}</td>
            <td>{{fac.CustomerName}}</td>
            <td>{{fac.StatusName}}</td>
            <td>{{fac.DueDate }}</td>
            <td>{{fac.Total | currency: 'EUR': 'symbol'}}</td>
            <td>{{fac.Balance | currency: 'EUR': 'symbol'}}</td>
            <td><button (click)="getFactura(fac.InvoiceID)" style="color: teal;" class="btn btn-white"><i
                  class="fas fa-marker"></i></button></td>
            <td><button (click)="deleteFactura(fac.InvoiceID)" style="color:brown;" class="btn btn-white"><i
              class="fas fa-trash-alt"></i></button></td>
            <td>
              <div class="btn-group">
                <button style="color: black;" class="btn btn-white" data-toggle="dropdown"><i class="fas fa-angle-down"></i></button>
                <ul class="dropdown-menu" role="menu">
                  <button (click)="sendInvoice(fac.InvoiceID, fac.OrganizationName, fac.CustomerName, fac.InvoiceNumber)" style="color: royalblue;" class="btn btn-white"><i class="fas fa-envelope"></i> Enviar email</button><br>
                  <button (click)="imprimirPDF(fac.InvoiceID)" style="color: brown;" class="btn btn-white"><i class="far fa-file-pdf"></i> Imprimir PDF</button>
                  <button (click)="hacerPago()" style="color: rgb(0, 0, 0);" class="btn btn-white"><i class="fas fa-money-bill-wave"></i> Registrar pago</button>
                  <button (click)="clonar()" style="color: rgb(42, 165, 134);" class="btn btn-white"><i class="fas fa-clone"></i> Clonar</button>
                </ul>
              </div>
            </td>
            
          </tr>
        </tbody>
      </table>

      <br *ngIf="facturas.length==0">
      <div style="margin-left: 350px; margin-right: 350px;" class="alert alert-info" *ngIf="facturas.length==0" role="alert">
        No hay facturas. Crea una!<button class="btn" routerLink="/facturas/añadir"><i class="fas fa-plus-circle"></i></button>
      </div>

      <pagination-controls style="float: right;" (pageChange)="page = $event"></pagination-controls>

      <ng-template #sinfacturas>
        <p>No hay Facturas.</p>
      </ng-template>

      </div>
    </div>

    <div *ngIf="upd" class="row">
      <div class="col-md-12 mx-auto">
        <br>
        <div class="card">
          <div class="card-header" style="text-align: center;">
              Actualizar Factura
          </div>
     
          <div class="card-body">
            <button style="margin-left: 450px;" (click)="flagger()" class="btn btn-outline-dark btn-sm"><i  class="fas fa-plus-circle"></i> Añadir Línea</button>
            <br><br>
            <div class="table-responsive">
                <table class="table table-hover" *ngIf="hayRegistros()">
                    <thead>
                        <tr>
                        <td><strong>Producto/Servicio</strong></td>
                        <td><strong>Descripción</strong></td>
                        <td><strong>Cantidad</strong></td>
                        <td><strong>Precio</strong></td>
                        <td><strong>% Dcto</strong></td>
                        <td><strong>% IVA</strong></td>
                        <td><strong>% IRPF</strong></td>
                        <td><strong>Importe</strong></td>
                        <td><strong>Editar</strong></td>
                        <td><strong>Borrar</strong></td>
                    </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let lin of lineas">
                        <td>{{lin.ProductName}}</td>
                        <td>{{lin.ProductDescription}} </td>
                        <td>{{lin.Quantity}} </td>
                        <td>{{lin.ProductPrice}} </td>
                        <td>{{lin.Discount}} </td>
                        <td>{{lin.ProductTax1Rate}} </td>
                        <td>{{lin.ProductTax2Rate}} </td>
                        <td>{{lin.ProductTotal}} </td>
                        <td><button (click)="getFacturaLinea(lin.Invoice_LineID)" style="color: teal;" class="btn btn-white"><i class="fas fa-marker"></i></button></td>
                        <td><button (click)="deleteFacturaLinea(lin.Invoice_LineID)" style="color: brown;" class="btn btn-white" ><i class="fas fa-trash-alt"></i></button></td>
                    </tr>
                    </tbody>
                </table>
                <br *ngIf="lineas.length==0">
                <div style="margin-left: 350px; margin-right: 350px;" class="alert alert-info" *ngIf="lineas.length==0" role="alert">
                  No hay lineas. Crea una!<button class="btn" (click)="flagger()"><i class="fas fa-plus-circle"></i></button>
                </div>
            </div>
            <br>
            <div class="form-group">
              <label for="">Seleccione un Cliente *</label><button (click)="newCliente()" class="btn"><i class="fas fa-plus-circle" style="color: #7bbff0;"></i></button>
              <select required style="border-radius: 20px;" name="my-select" [(ngModel)]="mySelect" [(ngModel)]="fac.CustomerID"  class="form-control" (change)="selectChange()">
                  <option [value]="item.id" *ngFor="let item of clientes">{{item.CustomerName}}</option>
              </select>
            </div>
      

          <div class="form-row">
              <div class="col">
                  <label for="">OrganizationID</label>
                  <input type="text" #OrganizationID="ngModel" class="form-control" [(ngModel)]="fac.OrganizationID" readonly />
              </div>
              <div class="col">
                  <label for="">Número Factura</label>
                  <input type="text" [(ngModel)]="fac.InvoiceNumber" class="form-control" readonly />
              </div>
              <div class="col">
                  <label for="">Fecha</label>
                  <input type="date" [(ngModel)]="fac.InvoiceDate" class="form-control"/>
              </div>
          </div>
          <br>
          <div class="form-row">
              <div class="col">
                  <label for="">Fecha Vencimiento</label>
                  <input type="date" [(ngModel)]="fac.DueDate" class="form-control" />
              </div>
              <div class="col">
                  <label for="">P.O Referencia</label>
                  <input type="text" [(ngModel)]="fac.PurchaseOrder" class="form-control" />
              </div>
          </div>
         <br>
          <div class="form-row">
              <div class="col">
                  <label for="">Notas</label>
                  <input type="text" [(ngModel)]="fac.Notes" class="form-control" />
              </div>
              <div class="col">
                  <label for="">Términos y condiciones</label>
                  <textarea type="text" #TermsConditions="ngModel" class="form-control" [(ngModel)]="fac.TermsConditions" readonly></textarea>
              </div>
          </div>
          <br>
      
          <div class="form-row">
              <div class="col">
                  <label for="">Descuento</label>
                  <input type="text" #Discount="ngModel" class="form-control" [(ngModel)]="fac.Discount" readonly />
              </div>
              <div class="col">
                  <label for="">Base imponible</label>
                  <input type="text" #SubTotal="ngModel" class="form-control" [(ngModel)]="fac.SubTotal" readonly />
              </div>
              <div class="col">
                  <label for="">IVA</label>
                  <input type="text" #IVA="ngModel" class="form-control" [(ngModel)]="fac.IVA" readonly />
              </div>
              <div class="col">
                  <label for="">IRPF</label>
                  <input type="text" #IRPF="ngModel" class="form-control" [(ngModel)]="fac.IRPF" readonly />
              </div>
              <div class="col">
                  <label for="">Total</label>
                  <input type="text" #Total="ngModel" class="form-control" [(ngModel)]="fac.Total" readonly />
              </div>
          </div>
          <br>
          <div class="form-group">
            <button (click)="updateFactura()" class="btn btn-block btn-outline-dark">Actualizar</button>
          </div>
        
          </div>
      </div>
      </div>
    
    </div>

    <div *ngIf="updLin">

      <div class="row">
          <div class="col-md-8 mx-auto">
              <br>
              <div class="card">
                  <div class="card-header" style="text-align: center;">
                      Actualizar Línea
                  </div>
                  <div class="card-body">
  
                      <div class="form-row">
                          <div class="col">
                              <label for="">ID Factura</label>
                              <input type="text" #InvoiceID="ngModel" class="form-control" [(ngModel)]="lin.InvoiceID" readonly />
                          </div>
                          <div class="col">
                              <label for="">Número Factura</label>
                              <input type="text" #InvoiceNumber="ngModel" class="form-control" [(ngModel)]="lin.InvoiceNumber" readonly />
                          </div>
                      </div>
  
                      <div class="form-group">
                          <label for="">Producto *</label><button (click)="newProducto()" class="btn"><i class="fas fa-plus-circle" style="color: #7bbff0;"></i></button>
                          <select  style="border-radius: 20px;" name="my-select" [(ngModel)]="mySelect1"  [(ngModel)]="lin.ProductID" class="form-control" (change)="selectChange1()">
                              <option [value]="item.id" *ngFor="let item of productos">{{item.ProductName}}</option>
                          </select>
                      </div>
  
                      <div class="form-row">
                          <div class="col">
                              <label for="">Descripción</label>
                              <input type="text" [(ngModel)]="lin.ProductDescription"  class="form-control" />
                          </div>
                          <div class="col">
                              <label for="">Cantidad</label>
                              <input type="text" [(ngModel)]="lin.Quantity"  class="form-control" />
                          </div>
                          <div class="col">
                              <label for="">Precio</label>
                              <input type="text" [(ngModel)]="lin.ProductPrice"  class="form-control" />
                          </div>
                          <div class="col">
                              <label for="">Descuento</label>
                              <input type="text" [(ngModel)]="lin.Discount"  class="form-control" />
                          </div>
                      </div>
                      <div class="form-row">
                          <div class="col">
                              <label for="">IVA</label><button (click)="newImpuesto()" class="btn"><i class="fas fa-plus-circle" style="color: #7bbff0;"></i></button>
                              <select style="border-radius: 20px;" name="my-select" [(ngModel)]="myPercentaje" [(ngModel)]="lin.ProductTax1Rate" class="form-control" (change)="selectPercentage()">
                                  <option [value]="item.id" *ngFor="let item of impuestos">{{item.id}} - {{item.TaxName}}</option>
                              </select>
                          </div>
                          <div class="col">
                              <label for="">IRPF</label><button (click)="newImpuesto()" class="btn"><i class="fas fa-plus-circle" style="color: #7bbff0;"></i></button>
                              <select style="border-radius: 20px;" name="my-select1" [(ngModel)]="myPercentaje1" [(ngModel)]="lin.ProductTax2Rate" class="form-control" (change)="selectPercentage1()">
                                <option [value]="item.id" *ngFor="let item of impuestos1">{{item.id}} - {{item.TaxName}}</option>
                              </select>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="">Importe</label>
                          <input type="text" #ProductTotal="ngModel" class="form-control" [(ngModel)]="lin.ProductTotal" readonly />
                      </div>
                      <br>
                      <div class="form-row">
                          <button (click)="updateFacturaLinea()" class="btn btn-block btn-outline-dark">Actualizar</button>
                      </div>
                  </div>
              </div>
          </div>
      </div>  
      
  </div>
    
  
    <router-outlet></router-outlet>

  </div>